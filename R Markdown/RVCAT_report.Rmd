---
output:
  word_document:
    reference_docx: wordstyles.docx
  pdf_document:
    fig_caption: yes
    
---

```{r setup, results='hide', echo=FALSE, message=FALSE, warning=FALSE}

library(rmarkdown)
library(tinytex)
library(knitr)
library(tidyverse)
library(doBy)
library(readxl)
library(ggplot2)
library(plotrix)
library(psych)
library(rlang)
library(purrr)
library(forcats)
library(viridis)
library(reshape)
library(rgdal)
library(xlsx)
library(lubridate)
library(gganimate)
library(magick)
library(grid)
library(ggforce)
library(kableExtra)
library(here)

##load the raw RVCAT data file
##NOTE: this code is designed to process the ENTIRE RVCAT output, you can subset out target codes, species, years, etc later
##you DO NOT need to spool off a specialized RVCAT file with just the data you want to analyze
raw.data<-read.csv(here('Data','RVCAT.csv'))
raw.data$SPECIES<-as.factor(raw.data$SPECIES)

##change date format into usable form
raw.data$OP_DATE<-as.character(raw.data$OP_DATE)
raw.data$OP_DATE<-parse_date(raw.data$OP_DATE, format='%d-%b-%y')

raw.data[is.na(raw.data[,"END_LATITUDE_DD"]), "END_LATITUDE_DD"] <- raw.data[is.na(raw.data[, "END_LATITUDE_DD"]),"BEG_LATITUDE_DD"]
raw.data[is.na(raw.data[,"BEG_LATITUDE_DD"]), "BEG_LATITUDE_DD"] <- raw.data[is.na(raw.data[, "BEG_LATITUDE_DD"]),"END_LATITUDE_DD"]

raw.data[is.na(raw.data[,"END_LONGITUDE_DD"]), "END_LONGITUDE_DD"] <- raw.data[is.na(raw.data[, "END_LONGITUDE_DD"]),"BEG_LONGITUDE_DD"]
raw.data[is.na(raw.data[,"BEG_LONGITUDE_DD"]), "BEG_LONGITUDE_DD"] <- raw.data[is.na(raw.data[, "BEG_LONGITUDE_DD"]),"END_LONGITUDE_DD"]

raw.data$Mid.Lat.DD<-(raw.data$BEG_LATITUDE_DD+raw.data$END_LATITUDE_DD)/2
raw.data$Mid.Long.DD<-(raw.data$BEG_LONGITUDE_DD+raw.data$END_LONGITUDE_DD)/2

##load the species names file for when needed
codes.to.names<-read_xlsx(here('Data','Species_Taxonomy.xlsx'))
sci.names<-select(codes.to.names, c(2:4))

##set default themes for all plots and maps
map_theme<-theme(axis.text=element_text(size=20, family='serif'), 
            axis.title=element_text(size=20, family='serif'), 
            plot.title=element_text(size=24, family='serif'),
            plot.subtitle=element_text(size=18, family='serif'),
            plot.caption=element_text(size=16, family='serif'), 
            legend.position=c(0.08,0.7),
            legend.text=element_text(size=16, family='serif'))
plot_theme<-theme(axis.line=element_line(size=1, color='black'),
                  panel.background = element_rect(NA),
                  axis.text=element_text(size=20, family='serif'),
                  axis.title=element_text(size=20, family='serif'),
                  plot.margin = margin(.5,.5,.5,.5,"cm"),
                  legend.text=element_text(size=16, family='serif'),
                  axis.ticks=element_line(size=1, color='black'),
                  plot.title=element_text(size=24, family='serif'),
                  plot.subtitle=element_text(size=16, family='serif'),
                  plot.caption=element_text(size=16, family='serif'),
                  legend.background = element_blank(),
                  legend.key = element_blank(),
                  strip.text=element_text(size=16, family='serif'))


ann_data_access<-'Data: U.S. Geological Survey, doi.org/10.5066/F75M63X0'
ann_data_access2<-'doi.org/10.5066/F75M63X0'
##to calculate NOHA and KGHA, need to subset out different vessels, as they have different conversion factors for area sampled

##r/v siscowet from start to 1976 **note, conversion factor only verified from 1973-1976, an estimate for years prior
siscowet76<-subset(raw.data, VESSEL==1 & YEAR<1977)
siscowet76$NOHA<-((siscowet76$NUM*60)/siscowet76$TOW_TIME)/2.01
siscowet76$KGHA<-((siscowet76$WT*.06)/siscowet76$TOW_TIME)/2.01
siscowet76$HA_SWEPT<-(siscowet76$TOW_TIME/60)*2.01

##r/v siscowet from 1977-1999
siscowet77.99<-subset(raw.data, VESSEL==1 & YEAR>1976 & YEAR<2000)
siscowet77.99$NOHA<-((siscowet77.99$NUM*60)/siscowet77.99$TOW_TIME)/2.45
siscowet77.99$KGHA<-((siscowet77.99$WT*.06)/siscowet77.99$TOW_TIME)/2.45
siscowet77.99$HA_SWEPT<-(siscowet77.99$TOW_TIME/60)*2.45

##r/v grayling 1973-1999 (all years)
grayling<-subset(raw.data, VESSEL==11)
grayling$NOHA<-((grayling$NUM*60)/grayling$TOW_TIME)/2.05
grayling$KGHA<-((grayling$WT*.06)/grayling$TOW_TIME)/2.05
grayling$HA_SWEPT<-(grayling$TOW_TIME/60)*2.05

##r/v coaster, USGS, 1993 serials 1-120
coaster93<-subset(raw.data, VESSEL==99 & YEAR==1993 & SERIAL<121)
coaster93$NOHA<-((coaster93$NUM*60)/coaster93$TOW_TIME)/.6097
coaster93$KGHA<-((coaster93$WT*.06)/coaster93$TOW_TIME)/.6097
coaster93$HA_SWEPT<-(coaster93$TOW_TIME/60)*.6097

##r/v coaster, USGS, 1988-1992 and 1994-2004  and 1993 serials>120
coasterUSGS1<-subset(raw.data, VESSEL==99 & YEAR<1993)
coasterUSGS2<-subset(raw.data, VESSEL==99 & YEAR>1993)
coasterUSGS3<-subset(raw.data, VESSEL==99 & YEAR==1993 & SERIAL>120)
coasterUSGS<-rbind(coasterUSGS1, coasterUSGS2, coasterUSGS3)
coasterUSGS$NOHA<-((coasterUSGS$NUM*60)/coasterUSGS$TOW_TIME)/.785
coasterUSGS$KGHA<-((coasterUSGS$WT*.06)/coasterUSGS$TOW_TIME)/.785
coasterUSGS$HA_SWEPT<-(coasterUSGS$TOW_TIME/60)*.785

##r/v coaster/shoveler USFWS 2009 (calling it shoveler to differentiate from coaster above)
shoveler<-subset(raw.data, VESSEL==95)
shoveler$NOHA<-(shoveler$NUM/(((shoveler$DISTANCE*5280)*14.76)/107639.1))
shoveler$KGHA<-(shoveler$WT*.001/(((shoveler$DISTANCE*5280)*14.76)/107639.1))
shoveler$HA_SWEPT<-((shoveler$DISTANCE*5280)*14.76)/107639.1

##r/v whitefish
whitefish<-subset(raw.data, VESSEL==50)
whitefish$NOHA<-((whitefish$NUM*60)/whitefish$TOW_TIME)/1.174
whitefish$KGHA<-((whitefish$WT*.06)/whitefish$TOW_TIME)/1.174
whitefish$HA_SWEPT<-(whitefish$TOW_TIME/60)*1.174

##johnboat
johnboat<-subset(raw.data, VESSEL==92)
johnboat$NOHA<-((johnboat$NUM*60)/johnboat$TOW_TIME)/.6568
johnboat$KGHA<-((johnboat$WT*.06)/johnboat$TOW_TIME)/.6568
johnboat$HA_SWEPT<-(johnboat$TOW_TIME/60)*.6568

##r/v kaho **note, don't have a conversion factor for this ship yet, using the conversion factor for the siscowet for now
kaho<-subset(raw.data, VESSEL==4)
kaho$NOHA<-((kaho$NUM*60)/kaho$TOW_TIME)/2.45
kaho$KGHA<-((kaho$WT*.06)/kaho$TOW_TIME)/2.45
kaho$HA_SWEPT<-(kaho$TOW_TIME/60)*2.45

##r/v kiyi
kiyi<-subset(raw.data, VESSEL==25)
kiyi$NOHA<-(kiyi$NUM/(((kiyi$DISTANCE*5280)*25.49)/107639.1))
kiyi$KGHA<-(kiyi$WT*.001/(((kiyi$DISTANCE*5280)*25.49)/107639.1))
kiyi$HA_SWEPT<-(((kiyi$DISTANCE*5280)*25.49)/107639.1)

##Daphnia **note, no bottom trawls done off this ship, so doesn't have all the same data as the other vessels
daphnia<-subset(raw.data, VESSEL==9)
daphnia$NOHA<-NA
daphnia$KGHA<-NA
daphnia$HA_SWEPT<-NA

##bind all data frames together now that they have NOHA and KGHA
all.data<-rbind(kiyi, siscowet76, siscowet77.99, grayling, coaster93, coasterUSGS, whitefish, johnboat, kaho, shoveler, daphnia)
##check that the number of rows in all.data matches the number in the raw.data input to make sure no data got lost along the way
##if data were lost, were any additional vessels used that are not listed above? any vessel codes changed or recorded incorrectly?

##TO TEST THE CODE, mutate 2011 data to 2025, this should show if everything is updating automatically. DELETE OR UNDO WHEN FINISHED!!
#all.data<-mutate(all.data, YEAR=ifelse(YEAR==2011,2025,YEAR))
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
##calculate summary stats needed for abstract

maxyr<-all.data%>%
  subset(YEAR==max(YEAR))

maxyr_stations<-select(maxyr, 'LOCATION', 'TARGET')
maxyr_stations<-as.data.frame(unique(maxyr_stations))
maxyr_nsstations<-maxyr_stations%>%
  filter(TARGET=='2')
maxyr_osstations<-maxyr_stations%>%
  filter(TARGET=='118'|TARGET=='117')

##nearshore summary table
ns<-subset(all.data, TARGET==2 & YEAR>1977)

ns.sites.byyear<-ns%>%
  group_by(YEAR)%>%
  distinct(LOCATION)
ns.sites.byyear$SITECHECK<-'SURVEYED'

ns.summary<-select(ns, c(4,8,29,35))
ns.unique.sites<-ns.sites.byyear%>% ##to calculate the number of sites sampled during the nearshore cruise each year
  group_by(YEAR)%>%
  dplyr::count('LOCATION')%>%
  select(c(1,3))%>%
  renameCol('n','Sites')
ns.total.biomass<-aggregate(ns.summary$KGHA, by=list(YEAR=ns.summary$YEAR, LOCATION=ns.summary$LOCATION), FUN=sum)%>% 
  renameCol('x', 'SiteSum')
ns.zero.sites<-subset(ns.total.biomass, SiteSum==0) ##to calculate the number of sites where no fish were caught
ns.zero.sites<-ns.zero.sites%>%
  group_by(YEAR)%>%
  dplyr::count()%>%
  renameCol('n','No fish sites')
ns.total.biomass2<-aggregate(ns.total.biomass$SiteSum, by=list(YEAR=ns.total.biomass$YEAR), FUN=mean)%>% ##mean total biomass
  renameCol('x','Total biomass')
ns.median.biomass<-aggregate(ns.total.biomass$SiteSum, by=list(YEAR=ns.total.biomass$YEAR), FUN=median)%>% ##median total biomass
  renameCol('x','Median biomass')
ns.spp.count<-merge.data.frame(ns.summary, sci.names) ##to calculate the mean biomass of various common species
ns.spp.count<-select(ns.spp.count, c(2:5))%>%
  renameCol('COMMON_NAME','SPECIES')
ns.spp.count<-merge.data.frame(ns.spp.count, ns.sites.byyear, by=c('YEAR','LOCATION'), all=T)
ns.spp.count<-cast(ns.spp.count, YEAR+LOCATION+SITECHECK~SPECIES, value='KGHA', fun.aggregate='mean')
ns.spp.count[is.na(ns.spp.count)]<-0
ns.spp.count<-select(ns.spp.count, c(1, 4:48))
ns.spp.count2<-aggregate(.~YEAR, ns.spp.count, FUN=mean)

##to list top species caught in ns
ns.spp.biomass.maxyr<-subset(ns.spp.count2, YEAR==max(YEAR))
ns.spp.biomass.maxyr<-melt(ns.spp.biomass.maxyr, id=c('YEAR'))
ns.spp.biomass.maxyr<-ns.spp.biomass.maxyr[with(ns.spp.biomass.maxyr, order(-value)),]
ns.topspp.maxyr<-ns.spp.biomass.maxyr[1:8,]

##to change which species you calculate average biomass for, change in the below lines
##note, sculpins are summed together, as are misc. spp.--this can be changed by moving those species into the ns.spp.common data frame
ns.spp.common<-select(ns.spp.count2, c('YEAR','Rainbow Smelt','Cisco','Lake Whitefish','Bloater','hatchery Lake Trout',
                                       'lean Lake Trout','siscowet Lake Trout','Burbot'))
ns.sculpins<-select(ns.spp.count2, c('YEAR','Slimy Sculpin','Spoonhead Sculpin','Deepwater Sculpin'))
ns.sculpins<-ns.sculpins%>%
  mutate(Sculpins = select(., c(2:4))%>%
           rowSums(na.rm=F))%>%
  select(c(1,5))
ns.misc.spp<-select(ns.spp.count2, c('YEAR', 'Ninespine Stickleback','Trout-perch','Kiyi','Shortjaw Cisco','Pygmy Whitefish',
                                     'Round Whitefish','Longnose Sucker'))
ns.misc.spp<-ns.misc.spp%>%
  mutate(Misc.Spp = select(., c(2:8))%>%
  rowSums(na.rm=F))%>%
  select(c(1,9))
ns.num<-select(ns, c(4,8,29,30))
ns.tot.spp.caught<-subset(ns.num, NUM>0) ##calculate the total number of species caught each year
ns.tot.spp.caught$spp2<-as.numeric(as.character(ns.tot.spp.caught$SPECIES))
ns.tot.spp.caught<-subset(ns.tot.spp.caught, spp2<999)
ns.tot.spp.caught<-select(ns.tot.spp.caught, c(1,3))
ns.tot.spp.caught<-unique(ns.tot.spp.caught)

ns.tot.spp.caught<-aggregate(ns.tot.spp.caught$SPECIES, by=list(YEAR=ns.tot.spp.caught$YEAR), FUN=length)%>%
  renameCol('x','Total species collected')

##merge all of the variables calculated above together into one data frame to export
ns.table<-merge.data.frame(ns.unique.sites,ns.zero.sites, all=T)
ns.table[is.na(ns.table)]<-0
ns.table<-merge.data.frame(ns.table, ns.tot.spp.caught)
ns.table<-merge.data.frame(ns.table, ns.total.biomass2)
ns.table<-merge.data.frame(ns.table, ns.median.biomass)
ns.table<-merge.data.frame(ns.table, ns.spp.common)
ns.table<-merge.data.frame(ns.table, ns.sculpins)
ns.table<-merge.data.frame(ns.table, ns.misc.spp)
ns.table<-renameCol(ns.table, 'YEAR','Year')
#mean(ns.table$`Total biomass`)
ns.table<-round(ns.table[,c(1:16)], 2)

##effort summary table############################################################################################effort table#####
effort<-all.data%>%
  filter(YEAR==max(YEAR))%>%
  filter(TARGET==2|TARGET==117|TARGET==118|TARGET==106)
effort$Depth_Range<-abs(effort$END_DEPTH-effort$BEG_DEPTH)
effort.unique<-effort[!duplicated(effort[,c('OP_ID')]),]

effort.trawldist<-effort.unique%>%
  group_by(TARGET)%>%
  do(describe(.$DISTANCE, ranges=T))
effort.trawldist$vars<-'TR_Distance'

effort.trawltime<-effort.unique%>%
  group_by(TARGET)%>%
  do(describe(.$TOW_TIME, ranges=T))
effort.trawltime$vars<-'TR_Duration'

effort.begdepth<-effort.unique%>%
  group_by(TARGET)%>%
  do(describe(.$BEG_DEPTH, ranges=T))
effort.begdepth$vars<-'BEG_DEPTH'

effort.enddepth<-effort.unique%>%
  group_by(TARGET)%>%
  do(describe(.$END_DEPTH, ranges=T))
effort.enddepth$vars<-'END_DEPTH'

effort.depthrange<-effort.unique%>%
  group_by(TARGET)%>%
  do(describe(.$Depth_Range, ranges=T))
effort.depthrange$vars<-'RANGE_DEPTH'

effort.station.sum<-aggregate(effort$KGHA, by=list(TARGET=effort$TARGET, LOCATION=effort$LOCATION), FUN=sum)%>%
  renameCol('x','KGHA')
effort.kgha<-effort.station.sum%>%
  group_by(TARGET)%>%
  do(describe(.$KGHA, ranges=T))
effort.kgha$vars<-'KGHA'
ns.effort.kgha<-subset(effort.kgha, TARGET==2)
os.effort.kgha<-subset(effort.kgha, TARGET==117|TARGET==118)

effort$SPECIES2<-as.numeric(as.character(effort$SPECIES))
effort.spp0<-subset(effort, SPECIES2==0)
effort.spp0<-select(effort.spp0, 'TARGET','LOCATION')
effort.spp0$SPP<-0
effort.spp1<-subset(effort, SPECIES2>0)
effort.spp.sum<-aggregate(effort.spp1$SPECIES, by=list(TARGET=effort.spp1$TARGET, LOCATION=effort.spp1$LOCATION), FUN=length)%>%
  renameCol('x','SPP')
effort.spp.sum<-rbind(effort.spp.sum, effort.spp0)
effort.spp<-effort.spp.sum%>%
  group_by(TARGET)%>%
  do(describe(.$SPP, ranges=T))
effort.spp$vars<-'N.SPP'
ns.effort.spp<-subset(effort.spp, TARGET==2)
os.effort.spp<-subset(effort.spp, TARGET==117|TARGET==118)


effort.all<-rbind(effort.trawldist, effort.trawltime, effort.begdepth, effort.enddepth, effort.depthrange, effort.spp, effort.kgha)
effort.all<-select(effort.all, c(1:4, 6, 9:10))
effort.all<-effort.all[order(effort.all$TARGET),]
effort.all<-effort.all%>%
  mutate_if(is.numeric, round, 2)
effort.all<-as.data.frame(effort.all)
#write.xlsx(effort.all, here('Plots and Tables','Effort_CurrentYear.xlsx'), row.names=FALSE)

effort.nfish<-aggregate(effort$NUM, by=list(TARGET=effort$TARGET), FUN=sum)%>%
  renameCol('x','N_Fish')
ns.nfish<-subset(effort.nfish, TARGET==2)
os.nfish<-subset(effort.nfish, TARGET==118|TARGET==117)

effort.unique.spp<-effort[!duplicated(effort$SPECIES2),]
effort.unique.spp<-effort.unique.spp%>%
  filter(TARGET==2|TARGET==117|TARGET==118)%>%
  filter(SPECIES2>0)

##catch totals
all.current.yr<-all.data%>%
  filter(YEAR==max(YEAR))%>%
  filter(TARGET==2|TARGET==117|TARGET==118)
all.current.yr$TARGET_f<-as.factor(all.current.yr$TARGET)

all.spp.counts<-aggregate(all.current.yr$NUM, by=list(SPECIES=all.current.yr$SPECIES, TARGET=all.current.yr$TARGET), FUN=sum)%>%
  renameCol('x','SUM')
all.spp.counts<-merge.data.frame(all.spp.counts, sci.names)
all.spp.counts<-select(all.spp.counts, c(4,5,2,3))
all.spp.counts2<-cast(all.spp.counts, COMMON_NAME+SCI_NAME~TARGET, value="SUM")
all.spp.counts2<-all.spp.counts2%>%
  renameCol('COMMON_NAME','Common name')%>%
  renameCol('SCI_NAME','Scientific name')%>%
  renameCol('2','Nearshore')%>%
  renameCol(4,'Offshore')
all.spp.counts2[is.na(all.spp.counts2)]<-0
all.spp.counts2<-all.spp.counts2[!all.spp.counts2$`Common name`=='Unidentified Coregonus',]
ns.spp.count<-select(all.spp.counts2, c(1,2,3))%>%
  subset(Nearshore>0)
os.spp.count<-select(all.spp.counts2, c(1,2,4))%>%
  subset(Offshore>0)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
##summarize nearshore data
ns<-subset(all.data, TARGET==2 & YEAR>1977)

##calculate mean biomass by year, start by getting total kgha for each station
ns.ann.station.sum<-aggregate(ns$KGHA, by=list(YEAR=ns$YEAR, Station=ns$LOCATION), FUN=sum)%>%
  renameCol('x','StationKGHA')

##calculate summary statistics
ns.summary <- ns.ann.station.sum%>% 
  group_by(YEAR) %>% 
  summarise_all(funs(mean,median,sd,std.error))%>%
  select(c(1,3,5,7,9))

#subset last 5 years and 10 years so means can be added to plot
ns.yr5mean<-subset(ns.summary, YEAR>=(max(YEAR)-4))
ns.yr10mean<-subset(ns.summary, YEAR>=(max(YEAR)-9))
ns.yr20mean<-subset(ns.summary, YEAR>=(max(YEAR)-19))
ns.yr30mean<-subset(ns.summary, YEAR>=(max(YEAR)-29))
ns.yr40mean<-subset(ns.summary, YEAR>=(max(YEAR)-39))

os<-subset(all.data, TARGET==118|TARGET==117 & YEAR>2010)%>%
  filter(TR_DESIGN==25|TR_DESIGN==4)%>%
  filter(END_DEPTH>84)
os.ann.station.sum<-aggregate(os$KGHA, by=list(YEAR=os$YEAR, Station=os$LOCATION,
                                               BEG_LONGITUDE_DD=os$BEG_LONGITUDE_DD,
                                               BEG_LATITUDE_DD=os$BEG_LATITUDE_DD), FUN=sum)%>%
  renameCol('x','StationKGHA')
os.ann.mean<-aggregate(os.ann.station.sum$StationKGHA, by=list(YEAR=os.ann.station.sum$YEAR), FUN=mean)%>%
  renameCol('x','Mean.KGHA')
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
##age-1 calculations
lengths<-read.csv(here('Data','LENGTHS_RVCAT.csv'))
op.id.details<-select(all.data, c(1,2,5,8,11,17,36))
lengths2<-merge.data.frame(lengths, op.id.details, by='OP_ID', all=F)
lengths3<-unique(lengths2)


##subset age 1 fish by species. use nearshore catches for all species except kiyi
rbs.a1<-lengths3%>%
  group_by(YEAR)%>%
  filter(SPECIES==109)%>%
  filter(LENGTH<101)%>%
  filter(TARGET==2)
cisco.a1<-lengths3%>%
  group_by(YEAR)%>%
  filter(SPECIES==202)%>%
  filter(LENGTH<141)%>%
  filter(TARGET==2)
bloater.a1<-lengths3%>%
  group_by(YEAR)%>%
  filter(SPECIES==204)%>%
  filter(LENGTH<131)%>%
  filter(TARGET==2)
kiyi.a1<-lengths3%>%
  group_by(YEAR)%>%
  filter(SPECIES==206)%>%
  filter(LENGTH<131)%>%
  filter(TARGET==118|TARGET==117)%>%
  filter(END_DEPTH>84)
siscowet.a1<-lengths3%>%
  group_by(YEAR)%>%
  filter(SPECIES==308)%>%
  filter(LENGTH<226)%>%
  filter(TARGET==2)
lean.a1<-lengths3%>%
  group_by(YEAR)%>%
  filter(SPECIES==317)%>%
  filter(LENGTH<226)%>%
  filter(TARGET==2)
lwf.a1<-lengths3%>%
  group_by(YEAR)%>%
  filter(SPECIES==203)%>%
  filter(LENGTH<161)%>%
  filter(TARGET==2)

age1<-rbind(rbs.a1, cisco.a1, bloater.a1, siscowet.a1, lean.a1, lwf.a1) ##bind all species evaluated using nearshore data
##need to process kiyi separate from the nearshore species so you can cast in zeros for nearshore sites where age 1 fish were not caught
age1.station.sum<-aggregate(age1$EXP_N, by=list(YEAR=age1$YEAR, LOCATION=age1$LOCATION, SPECIES=age1$SPECIES,
                                                HA_SWEPT=age1$HA_SWEPT), FUN=sum)%>%
  renameCol('x','N.Age1')

ns<-subset(all.data, TARGET==2 & YEAR>1976)
##need to cast in sites where no fish of that species were caught
##to do this, need to figure out which sites were sampled each year
ns.sites.byyear<-ns%>%
  group_by(YEAR)%>%
  distinct(LOCATION)
ns.sites.byyear$SITECHECK<-'SURVEYED'
os<-subset(all.data, TARGET==118|TARGET==117 & YEAR>2010)%>%
  filter(TR_DESIGN==25|TR_DESIGN==4)%>%
  filter(END_DEPTH>84)
##need to cast in sites where no fish of that species were caught
##to do this, need to figure out which sites were sampled each year. offshore=for kiyi calculations
os.sites.byyear<-os%>%
  group_by(YEAR)%>%
  distinct(LOCATION)
os.sites.byyear$SITECHECK<-'SURVEYED'

age1.station.sum<-merge.data.frame(age1.station.sum, ns.sites.byyear, all=T)
age1.station.sum$NOHA<-age1.station.sum$N.Age1/age1.station.sum$HA_SWEPT
age1.cast<-cast(age1.station.sum, YEAR+LOCATION~SPECIES, value='NOHA', fun.aggregate = 'mean')
age1.cast[is.na(age1.cast)]<-0
age1.cast<-select(age1.cast, c(1:8))
age1.cast<-melt(age1.cast, id=c('YEAR', 'LOCATION')) ##use this file later to map species densities
age1.ann.mean<-aggregate(age1.cast$value, by=list(Year=age1.cast$YEAR, SPECIES=age1.cast$SPECIES), FUN=mean)%>%
  renameCol('x','Mean.NOHA')

##now calculate kiyi (and any other offshore fishes if added later)
kiyi.a1<-aggregate(kiyi.a1$EXP_N,  by=list(YEAR=kiyi.a1$YEAR, LOCATION=kiyi.a1$LOCATION, SPECIES=kiyi.a1$SPECIES,
                                          HA_SWEPT=kiyi.a1$HA_SWEPT), FUN=sum)%>%
  renameCol('x','N.Age1')
kiyi.a1<-merge.data.frame(kiyi.a1, os.sites.byyear, all=T)
kiyi.a1$NOHA<-kiyi.a1$N.Age1/kiyi.a1$HA_SWEPT
kiyi.age1.cast<-cast(kiyi.a1, YEAR+LOCATION~SPECIES, value='NOHA', fun.aggregate = 'mean')
kiyi.age1.cast[is.na(kiyi.age1.cast)]<-0
kiyi.age1.cast<-select(kiyi.age1.cast, c(1:3))
kiyi.age1.cast<-melt(kiyi.age1.cast, id=c('YEAR', 'LOCATION'))

kiyi.a1.ann.mean<-aggregate(kiyi.age1.cast$value, by=list(Year=kiyi.age1.cast$YEAR, SPECIES=kiyi.age1.cast$SPECIES), FUN=mean)%>%
  renameCol('x','Mean.NOHA')

##bind together nearshore and offshore calculations and format for table export 
age1.ann.mean<-rbind(age1.ann.mean, kiyi.a1.ann.mean)
age1.ann.mean<-merge.data.frame(age1.ann.mean, sci.names, all=F)%>%
  select(c(2,3,4))
age1.ann.mean2<-cast(age1.ann.mean, Year~COMMON_NAME, value='Mean.NOHA')
age1.ann.mean2$'Year Class'<-age1.ann.mean2$Year-1
  
age1.table<-select(age1.ann.mean2, c('Year','Year Class','Rainbow Smelt','Cisco','Bloater','Lake Whitefish','Kiyi','lean Lake Trout',
                                     'siscowet Lake Trout')) ##if any spp added in future, select them in the order you want here
age1.table<-round(age1.table, 2) ##if you want more or less decimal places, adjust the numeric value here to the number you want
age1.table<-age1.table%>%
  filter(Year>1977) ##select the most recent 40 years, or whatever time period is desired
age1.table[is.na(age1.table)]<-'N/A' ##kiyi will have N/A values for years prior to the start of the offshore cruise (2011)

age1.table<-age1.table %>% dplyr::rename_all(funs(make.names(.)))
age1.table$Kiyi<-as.numeric(as.character(age1.table$Kiyi))

age1.maxyr<-subset(age1.table, Year==max(Year))


```


**Status and Trends in the Lake Superior Fish Community, `r max(all.data$YEAR)`**

Mark R. Vinson, Lori M. Evrard, Owen T. Gorman, Caroline L. Rosinski, Daniel L. Yule
U.S. Geological Survey Great Lakes Science Center Lake Superior Biological Station

2800 Lakeshore Drive East, Ashland, Wisconsin 54806 (mvinson@usgs.gov)

**Abstract**

The Lake Superior fish community was sampled in `r max(all.data$YEAR)` with daytime bottom trawls at `r length(maxyr_nsstations$LOCATION)` nearshore and `r length(maxyr_osstations$LOCATION)` offshore stations distributed throughout the lake. In the nearshore zone, `r ns.nfish$N_Fish` fish from `r length(ns.spp.count$Nearshore)` species or morphotypes were collected. The number of species collected at nearshore stations ranged from `r ns.effort.spp$min` to `r ns.effort.spp$max`, with a mean of `r round(ns.effort.spp$mean,1)` and median of `r round(ns.effort.spp$median, 1)`. Nearshore mean biomass was `r round(ns.effort.kgha$mean,1)` kg/ha which was **similar to** the past twenty-year average of `r round(mean(ns.yr20mean$StationKGHA_mean), 1)` kg/ha and **less than** the `r length(ns.summary$YEAR)`-year period-of-record mean of `r round(mean(ns.summary$StationKGHA_mean),1)` kg/ha. `r ns.topspp.maxyr$variable` had the highest total collected biomass. In the offshore zone, `r os.nfish$N_Fish` fish from `r length(os.spp.count$Offshore)` species or morphotypes were collected. The number of species collected at offshore stations ranged from `r os.effort.spp$min` to `r os.effort.spp$max`, with a mean of `r round(os.effort.spp$mean,1)` and median of `r round(os.effort.spp$median, 1)`. **Catches in this survey are dominated in both counts and biomass by Kiyi, Deepwater Sculpin, and siscowet Lake Trout.** Mean offshore biomass for all species in `r max(all.data$YEAR)` was `r round(os.effort.kgha$mean, 1)` kg/ha which was **greater than** the period-of-record `r length(os.ann.mean$Mean.KGHA)`-year average of `r round(mean(os.ann.mean$Mean.KGHA),1)` kg/ha. Median biomass for all offshore species in `r max(all.data$YEAR)` was `r round(os.effort.kgha$median,1)` kg/ha. Recruitment, as measured by age-1 densities, were **near the period-of-record lakewide average** for Lake Whitefish (`r round(age1.maxyr$Lake.Whitefish,1)` fish/ha) and Rainbow Smelt (`r round(age1.maxyr$Rainbow.Smelt,1)` fish/ha) and were **lower than** the period-of-record lakewide average for Bloater (`r round(age1.maxyr$Bloater, 1)` fish/ha), Kiyi (`r round(age1.maxyr$Kiyi,1)` fish/ha), and Cisco (`r round(age1.maxyr$Cisco,1)` fish/ha). Survival of *Coregonus* species to age-1 continues to be a major concern of fishery managers. 


The data associated with this report have not received final approval by the U.S. Geological Survey (USGS) and are currently under review. The Great Lakes Science Center is committed to complying with the Office of Management and Budget data release requirements and providing the public with high quality scientific data. We plan to release all USGS research vessel data collected between 1958 and 2019 and make those publicly available. Please direct questions to our Information Technology Specialist, Scott Nelson, at snelson@usgs.gov.

**Introduction**

The U.S. Geological Survey Lake Superior Biological Station conducts annual daytime bottom trawl surveys in nearshore (~15-80 m depths) and offshore (~100-300 m depths) waters of Lake Superior. These surveys provide data for assessment of trends in species occurrence, relative abundance, and biomass for principally demersal fish. These data have historically been considered population indices rather than absolute abundance and biomass estimates. The nearshore survey has been conducted annually since 1978 in U.S. waters, and since 1989 in Canadian waters. The offshore survey has been conducted annually since 2011. The primary goal of the surveys is to report on population biomass estimates for common species and age-1 density estimates (a.k.a., recruitment index) for selected commercial and recreational species (Rainbow Smelt, Cisco, Bloater, Kiyi, Lake Whitefish, and Lake Trout, scientific names are provided in Table 1). Age and diet analyses are conducted for selected species. Fish population data in this report are based solely on bottom trawl sampling. Fishing gear bias should be considered when interpreting the results, particularly for species with lower vulnerability to daytime bottom trawls, such as adult Cisco and adult Lake Trout (Yule, et al. 2008. Factors affecting bottom trawl catches: implications for monitoring the fishes of Lake Superior. North American Journal of Fisheries Management, 28:109-122). At each fish sampling station, larval fish are sampled by surface trawling, zooplankton are sampled by a whole water column (up to 100 m) vertical zooplankton tow, and an electronic water profiler is deployed that collects data on depth, water temperature, specific conductance, pH, dissolved oxygen, chlorophyll a, photosynthetic active radiation (PAR), and beam transmission. Herein we report on bottom trawl fish and water temperatures collected during the survey.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
##summary stats for methods
ns.effort.begdepth<-subset(effort.begdepth, TARGET==2)
ns.effort.enddepth<-subset(effort.enddepth, TARGET==2)
ns.effort.dist<-subset(effort.trawldist, TARGET==2)

os.effort.begdepth<-subset(effort.begdepth, TARGET==117|TARGET==118)
os.effort.enddepth<-subset(effort.enddepth, TARGET==117|TARGET==118)
os.effort.dist<-subset(effort.trawldist, TARGET==117|TARGET==118)
```


**Methods**

**Nearshore survey bottom trawling**

Nearshore sites are located around the perimeter of the lake. In `r max(all.data$YEAR)`, `r length(maxyr_nsstations$LOCATION)` of 78 planned long-term sampling locations were sampled between **29 May and 22 June** (Figure 1). At each location, a single bottom trawl tow was conducted with a 12-m Yankee bottom trawl with either a chain or 6-inch rubber roller foot rope. The roller foot rope was used at sites with steeper, rockier bottoms to reduce snagging. The median start and end depths for bottom trawl tows were `r round(ns.effort.begdepth$median,0)` m (range `r round(ns.effort.begdepth$min, 0)`-`r round(ns.effort.begdepth$max,0)` m) and `r round(ns.effort.enddepth$median,0)` m (range `r round(ns.effort.enddepth$min,0)`-`r round(ns.effort.enddepth$max, 0)` m), respectively. The median distance trawled was `r round(ns.effort.dist$median,2)` km (range `r round(ns.effort.dist$min,1)`-`r round(ns.effort.dist$max,1)` km). The median trawl wingspread was **9.0 m (range 7.0-11.9 m)**. Fish collected in trawls were sorted by species, counted, and weighed in aggregate to the nearest gram. Total length was measured on a maximum of 50 individuals per species per trawl. Lengths for these individuals were extrapolated to the entire catch when more than 50 individuals were collected. Relative density (fish/ha) and biomass (kg/ha) were estimated by dividing sample counts and aggregate weights by the area of the bottom swept by each trawl tow (ha). Biomass estimates are reported for all species combined and individually for Burbot, Cisco, Bloater, Rainbow Smelt, Lake Whitefish, Sculpin species (Slimy-, Spoonhead-, and Deepwater Sculpin), hatchery-, lean-, and siscowet Lake Trout, and for a few less common species. A composite estimate is also reported for all of the less-common species. Age-1 year-class strength was estimated as the mean lakewide density of age-1 fish as determined by total length; Cisco <140 mm, Bloater <130 mm, Lake Whitefish <160 mm, and Rainbow Smelt <100 mm. Young Lake Trout densities are presented for small, <226 mm (ca. < age-3) fish. These age-size cutoffs were based on past unpublished age estimates and are approximate and are known to vary among years.  


```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
##sample site map########################################################################################################MAP##########
##NOTE: need to have the shapefiles folder in your working directory for these to work

ls_poly <- readOGR(dsn = here('Data',"shapefiles/LakeSuperior"), layer = "lake_superior")
ls_poly <- spTransform(ls_poly, CRS("+proj=longlat"))
ls_poly.fort <- fortify(ls_poly)

##subset out the current year, and nearshore and offshore targets (if you want Cheq Bay, can add that target code)
all.current.yr<-all.data%>%
  filter(YEAR==max(YEAR))%>%
  filter(TARGET==2|TARGET==117|TARGET==118)
all.current.yr$TARGET_f<-as.factor(all.current.yr$TARGET)
```

```{r,fig.width=10, fig.height=6, dpi=300, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(all.current.yr, aes(BEG_LONGITUDE_DD, BEG_LATITUDE_DD)) +
  theme_bw() +
  scale_y_continuous(name='Latitude')+
  scale_x_continuous(name='Longitude',breaks=c(-93,-92,-91,-90,-89,-88,-87,-86,-85,-84), 
                     labels=c('-93','-92','-91','-90','-89','-88','-87','-86','-85','-84'))+
  geom_path(data = ls_poly.fort, aes(long, lat, group = group), size = 0.5)+
  geom_point(data=all.current.yr, mapping=aes(BEG_LONGITUDE_DD, BEG_LATITUDE_DD, color=TARGET_f), size=6, stroke=1.5)+
  scale_color_manual(values=c('salmon','cadetblue2'), name='Survey', labels=c('Nearshore','Offshore'))+
  map_theme+
  geom_text(aes(label=LOCATION))+
  labs(caption=ann_data_access,
       title='Lake Superior Stations Sampled',
       subtitle=(paste('USGS bottom trawl assessment, ', all.current.yr$YEAR)))

```
*Figure 1.* Location of `r length(maxyr_nsstations$LOCATION)` nearshore (orange) and `r length(maxyr_osstations$LOCATION)` offshore (aqua) stations sampled May-July `r max(all.data$YEAR)`. Samples collected at each location included bottom trawls for demersal fish, surface trawls for larval fish, and whole water column (up to 100 m) zooplankton collections, and a water profile that electronically collected data on depth, temperature, specific conductance, pH, dissolved oxygen, chlorophyll a, photosynthetic active radiation, and beam transmission. 

**Offshore survey bottom trawling**

Offshore sites were selected using a spatially-balanced, depth-weighted probabilistic sampling design that targets depths >90 m (Figure 1). Sample sites were selected in 2011 and these same sites have been sampled annually thereafter. In `r max(all.data$YEAR)`, `r length(maxyr_osstations$LOCATION)` locations were sampled during daylight hours from **11-25 July**. A single bottom trawl tow was conducted at each site using a 12-m Yankee bottom trawl with a 6-inch rubber roller foot rope. All tows were made on-contour for 20 minutes. Station depths ranged from `r round(os.effort.begdepth$min,0)` to `r round(os.effort.begdepth$max,0)` m. The median trawl distance was `r round(os.effort.dist$median,1)` km (range `r round(os.effort.dist$min,1)`-`r round(os.effort.dist$max,1)` km). The median trawl wing spread was **11.1 m (range 9.7-12.4 m)**. Catches were processed with the same methods described for nearshore trawls. Biomass estimates are presented for Kiyi, Deepwater Sculpin, and siscowet Lake Trout. Year-class recruitment strength was estimated for Kiyi as the mean lakewide density of Kiyi <130 mm collected at offshore stations. 

**Results**
```{r, echo=FALSE, message=FALSE, warning=FALSE}
##BT Data
data1 <- read_excel(here('Data',"LSBS_BTdata.xlsx"), sheet="BTData") %>%
  as.data.frame() 

data2 <-read_excel(here('Data',"LSBS_BTdata.xlsx"), sheet="BTSample") %>%
  as.data.frame() 

data2<-select(data2,1,4,5,11,14,15,17)

data2$Date<-format(as.POSIXct(data2$Date,format='%Y/%m/%d'),format='%Y/%m/%d')
##data2$Month<-format(as.POSIXct(data2$Date,format='%Y/%m/%d'),format='%m')
data2$Month<-month(ymd(data2$Date), label = TRUE, abbr = FALSE)
data2$Year<-format(as.POSIXct(data2$Date,format='%Y/%m/%d'),format='%Y')
data2$Time<-format(as.POSIXct(data2$Time,format='%Y/%m/%d %H:%M:%S'),format='%H:%M:%S')

data2$Longitude<-abs(data2$Longitude)*-1

data2 <- data1 %>%
  group_by(Sample) %>%
  right_join(data2) 

data1<-data2[order(data2$Date),] 
data1$Order<-1:nrow(data2)

###Subset data for most recent years
data1$Year<-as.numeric(as.character(data1$Year))
Sumdata1 <- data1 %>%
  subset(Target == 2 & Month == "June" & Year > (max(data1$Year)-10) & Depth <101 |
         Target == 117 & Month == "July" & Year >(max(data1$Year)-10) |
         Target == 118 & Month == "July" & Year >(max(data1$Year)-10)) 
facet_label <- c(June = "June - Nearshore Assessment" , July = "July - Offshore Assessment") 

Sumdata2 <-aggregate(Sumdata1$Temperature, by=list(Year=Sumdata1$Year, Month=Sumdata1$Month, Depth=Sumdata1$Depth), FUN=mean)%>%
  renameCol('x','mean_T')
Sumdata2$Year<-as.numeric(as.character(Sumdata2$Year))
Sumdata2<-subset(Sumdata2, Year>=(max(Year)-5))

Sumdata3 <-aggregate(Sumdata1$Temperature, by=list(Month=Sumdata1$Month, Depth=Sumdata1$Depth), FUN=mean)%>%
  renameCol('x','mean_T')
Sumdata3$Common<-'Mean'

temp_maxyr<-subset(Sumdata1, Year==max(Year))
temp_maxyr_june<-subset(temp_maxyr, Month=='June')
temp_june_surf<-subset(temp_maxyr_june, Depth<4)
temp_june_surf<-describe(temp_june_surf$Temperature)

temp_june_50<-subset(temp_maxyr_june, Depth==50)
temp_june_50<-describe(temp_june_50$Temperature)

temp_maxyr_july<-subset(temp_maxyr, Month=='July')
temp_july_surf<-subset(temp_maxyr_july, Depth<4)
temp_july_surf<-describe(temp_july_surf$Temperature)

temp_july_100<-subset(temp_maxyr_july, Depth==100)
temp_july_100<-describe(temp_july_100$Temperature)

temp_10yr_june_surf<-subset(Sumdata1, Month=='June' & Depth<4)
temp_10yr_june_surf<-describe(temp_10yr_june_surf$Temperature)

temp_10yr_june_50<-subset(Sumdata1, Month=='June' & Depth==50)
temp_10yr_june_50<-describe(temp_10yr_june_50$Temperature)

temp_10yr_july_surf<-subset(Sumdata1, Month=='July'&Depth<4)
temp_10yr_july_surf<-describe(temp_10yr_july_surf$Temperature)

temp_10yr_july_100<-subset(Sumdata1, Month=='July'&Depth==100)
temp_10yr_july_100<-describe(temp_10yr_july_100$Temperature)
```

**Nearshore survey**

Nearshore water temperatures in `r max(all.data$YEAR)` were **similar to** the ten-year average (Figure 2). Nearshore water temperatures in June averaged `r round(temp_june_surf$mean,1)` C (range = `r round(temp_june_surf$min, 1)`-`r round(temp_june_surf$max, 1)` C) at the surface and `r round(temp_june_50$mean, 1)` C (range = `r round(temp_june_50$min, 1)`-`r round(temp_june_50$max, 1)` C) at 50 m. The past ten-year average (`r (max(all.data$YEAR)-9)`-`r max(all.data$YEAR)`) water temperatures for these same locations and dates were `r round(temp_10yr_june_surf$mean,1)` C (range=`r round(temp_10yr_june_surf$min)`-`r round(temp_10yr_june_surf$max)` C) at the surface and `r round(temp_10yr_june_50$mean,1)` C (range = `r round(temp_10yr_june_50$min,1)`-`r round(temp_10yr_june_50$max,1)` C) at 50 m.

```{r,  fig.width=10, fig.height=6, dpi=300, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(Sumdata2, aes(x=mean_T, y=Depth, color =as.factor(Year))) +
  geom_point() +
  scale_color_manual(values=c('mediumaquamarine','sienna1','mediumpurple1','orchid2','darkseagreen4','gold1','black'), name='Year')+
  geom_line(data=Sumdata3, aes(color=Common), size = 1.5) +
  scale_y_reverse() +
  scale_x_continuous(limits=c(0, NA), breaks=seq(13), expand=c(0,0)) +
    labs(title = "Lake Superior Water Temperatures",
       subtitle = "USGS bottom trawl assessments",
       caption = ann_data_access,
       y = "Depth (m)", x = "Mean water temperature (C)") +
  plot_theme + 
  guides(colour = guide_legend(override.aes = list(shape=c(16,16,16,16,16,16,NA),size = 4, linetype=c(0,0,0,0,0,0,1)))) +
  theme(legend.position=c(0.9,0.5)) +
  facet_wrap(~Month, scales = "free", labeller = labeller(Month=facet_label))
```
*Figure 2.* Left) Average water temperature profiles across sites sampled during the June-Nearshore and (right) July-Offshore fish community assessments over the previous six years. The solid black line is the mean temperature over the previous ten years for the nearshore assessment and the previous **eight years** for the offshore assessment (2011-`r max(all.data$YEAR)`, excluding 2012 when no sampling was done in July). 
```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
##biomass at individual stations for the current sampling year, ranked by biomass--------------------------------BIOMASS BY STATION-----
##summarize nearshore data
ns<-subset(all.data, TARGET==2 & YEAR>1977)

##calculate mean biomass by year, start by getting total kgha for each station
ns.ann.station.sum<-aggregate(ns$KGHA, by=list(YEAR=ns$YEAR, Station=ns$LOCATION,
                                                   BEG_LONGITUDE_DD=ns$BEG_LONGITUDE_DD,
                                                   BEG_LATITUDE_DD=ns$BEG_LATITUDE_DD), FUN=sum)%>%
  renameCol('x','StationKGHA')

ns.current.yr<-ns.ann.station.sum%>%
  filter(YEAR==max(YEAR))
ns.current.yr$Station<-as.factor(ns.current.yr$Station)

ns.skewness<-ns.ann.station.sum%>%
  group_by(YEAR)%>%
  do(describe(.$StationKGHA))
ns.skewness<-select(ns.skewness, c(1,12))
ns.skew.maxyr<-subset(ns.skewness, YEAR==max(YEAR))
ns.ann.station.summaxyr<-subset(ns.ann.station.sum, YEAR==max(YEAR))

nsbiomap<-ggplot(ns.ann.station.summaxyr, aes(BEG_LONGITUDE_DD, BEG_LATITUDE_DD)) +
  theme_bw() +
  scale_y_continuous()+
  scale_x_continuous(breaks=c(-93,-92,-91,-90,-89,-88,-87,-86,-85,-84), 
                     labels=c('-93','-92','-91','-90','-89','-88','-87','-86','-85','-84'))+
  geom_path(data = ls_poly.fort, aes(long, lat, group = group), size = 0.5)+
  geom_point(data=ns.ann.station.summaxyr, mapping=aes(BEG_LONGITUDE_DD, BEG_LATITUDE_DD, color=StationKGHA), size=4, stroke=1.5)+
  scale_color_gradient(low='cadetblue2', high='red', name='Biomass\n(kg per ha)')+
  map_theme+
  geom_text(aes(label=Station))+
  labs( x='Longitude', y='Latitude')

##site names to list out the top sites
site.names<-read_excel(here('Data','Site_Names.xlsx'), sheet='Names')
site.names<-select(site.names, c(1,2))
ns.top.sites.maxyr<-merge.data.frame(ns.current.yr, site.names)
ns.top.sites.maxyr$SiteInfo<-paste(ns.top.sites.maxyr$Station, ns.top.sites.maxyr$NAME, sep='-')
ns.top.sites.maxyr<-ns.top.sites.maxyr[with(ns.top.sites.maxyr, order(-StationKGHA)),]
ns.top.5sites<-ns.top.sites.maxyr[1:5,]
```

A total of `r ns.nfish$N_Fish` fish from `r length(ns.spp.count$Nearshore)` species or morphotypes were collected at nearshore locations (Table 1). The number of species collected at each station ranged from `r ns.effort.spp$min` to `r ns.effort.spp$max`, with a mean of `r round(ns.effort.spp$mean,1)` and median of `r round(ns.effort.spp$median, 1)`. Estimated fish biomass at individual stations ranged from zero to `r round(max(ns.current.yr$StationKGHA),1)` kg/ha (Figure 3). The distribution of biomass estimated for all sampling locations was non-normally distributed (Figure 3) as is always the case for this survey. The skewness of the distribution of individual station biomass estimates in `r max(all.data$YEAR)` was `r round(ns.skew.maxyr$skew,1)` which was less than the period-of-record average skewness of `r round(mean(ns.skewness$skew),1)`. Individual stations with the highest biomass were `r ns.top.5sites$SiteInfo`. Lakewide average nearshore fish biomass was `r round(ns.effort.kgha$mean,1)` kg/ha, which was below the the `r length(ns.summary$YEAR)`-year period-of-record mean of `r round(mean(ns.summary$StationKGHA_mean),1)` kg/ha (Table 2, Figure 4). In relation to more recent estimates of fish biomass, the `r max(all.data$YEAR)` average nearshore biomass estimate was **similar to** the 20-year average of `r round(mean(ns.yr20mean$StationKGHA_mean), 1)` kg/ha and greater than the past 10 and 5-year averages of `r round(mean(ns.yr10mean$StationKGHA_mean), 1)` and `r round(mean(ns.yr5mean$StationKGHA_mean), 1)` kg/ha, respectively (Figure 4).   

```{r, fig.width=14, fig.height=8, dpi=300, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(ns.current.yr, aes(x=Station, y=StationKGHA, fill=StationKGHA))+
  geom_bar(stat='identity')+
  scale_fill_gradient(low='cadetblue2', high='red', name='Fish biomass\n(kg per ha)', guide=F)+
  annotation_custom(ggplotGrob(nsbiomap), ymin=10, ymax=49, xmax=55, xmin=3)+
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5, size=14))+
  plot_theme+
  aes(x=fct_reorder(Station, StationKGHA))+
  labs(x='Nearshore station identifier', y='Biomass (kg per ha)',
       caption=ann_data_access,
       title='Lake Superior Fish Biomass at Nearshore Stations',
       subtitle=(paste('USGS bottom trawl assessment, ', ns.current.yr$YEAR)))+
  scale_x_discrete(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0), breaks=c(0,5,10,15,20,25,30,35,40,45,50,55,60,65,70),
                     labels=c('0','5','10','15','20','25','30','35','40','45','50','55','60','65','70'))+
  geom_hline(yintercept = mean(ns.current.yr$StationKGHA), size=1)
```
*Figure 3.*  Estimated biomass (kg/ha) at individual nearshore sampling stations in `r max(all.data$YEAR)`. The horizontal like is the `r max(all.data$YEAR)` lakewide nearshore average biomass (`r round(ns.effort.kgha$mean,1)` kg/ha). The inset figure shows station locations and biomass (kg/ha) in `r max(all.data$YEAR)`. 

```{r, fig.width=10, fig.height=6, dpi=300, echo=FALSE, message=FALSE, warning=FALSE}

##plot mean nearshore biomass
ggplot(ns.summary, aes(x=YEAR, y=StationKGHA_mean))+
  geom_bar(stat='identity', fill='grey75', color='black')+
  plot_theme+
  labs(x='Year', y='Mean biomass (kg per ha)',caption=ann_data_access,
       title='Lake Superior Nearshore Fish Biomass',
       subtitle='USGS bottom trawl assessment')+
  scale_x_continuous(expand=c(0,0), breaks=c(1980,1985,1990,1995,2000,2005,2010,2015,2020,2025), 
                     labels=c('1980','1985','1990','1995','2000','2005','2010','2015','2020','2025'))+
  geom_errorbar(data=ns.summary, aes(x=YEAR, ymin=StationKGHA_mean-StationKGHA_std.error, ymax=StationKGHA_mean+StationKGHA_std.error),
                width=0.4)+
  scale_y_continuous(expand=c(0,0), breaks=c(5,10,15,20,25), labels=c('5','10','15','20','25'))+
  geom_segment(x=(max(ns.summary$YEAR)-4), xend=max(ns.summary$YEAR), y=mean(ns.yr5mean$StationKGHA_mean), #5 year mean
               yend=mean(ns.yr5mean$StationKGHA_mean), size=1.5, color='mediumorchid4')+
  geom_segment(x=(max(ns.summary$YEAR)-9), xend=max(ns.summary$YEAR), y=mean(ns.yr10mean$StationKGHA_mean), #10 year mean
               yend=mean(ns.yr10mean$StationKGHA_mean), size=1.5, color='darkolivegreen4')+
  geom_segment(x=(max(ns.summary$YEAR)-19), xend=max(ns.summary$YEAR), y=mean(ns.yr20mean$StationKGHA_mean), #20 year mean
               yend=mean(ns.yr20mean$StationKGHA_mean), size=1.5, color='cyan4')+
  geom_segment(x=(max(ns.summary$YEAR)-29), xend=max(ns.summary$YEAR), y=mean(ns.yr30mean$StationKGHA_mean), #30 year mean
               yend=mean(ns.yr30mean$StationKGHA_mean), size=1.5, color='lightpink3')+
  geom_segment(x=(max(ns.summary$YEAR)-39), xend=max(ns.summary$YEAR), y=mean(ns.yr40mean$StationKGHA_mean), #40 year mean
               yend=mean(ns.yr40mean$StationKGHA_mean), size=1.5, color='darkorange')

```
*Figure 4.* Annual nearshore biomass estimates (mean lakewide kg/ha +/- standard error) for all fish species collected in bottom trawls from 1978-`r max(all.data$YEAR)`. Horizontal lines are averages for the previous 5, 10, 20, 30, and 40 years. The number of sites sampled in each year is presented in Table 2.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ns.spp.biomass.maxyr<-subset(ns.spp.count2, YEAR==max(YEAR))
ns.spp.biomass.maxyr<-melt(ns.spp.biomass.maxyr, id=c('YEAR'))
ns.spp.biomass.maxyr<-ns.spp.biomass.maxyr[with(ns.spp.biomass.maxyr, order(-value)),]
ns.topspp.maxyr<-ns.spp.biomass.maxyr[1:8,]

ns.table<-ns.table%>% dplyr::rename_all(funs(make.names(.)))
ns.table.maxyr<-subset(ns.table, Year==max(Year))

ns.misc.spp.maxyr<-subset(ns.spp.biomass.maxyr, variable=='Ninespine Stickleback'|variable=='Trout-perch'|variable=='Kiyi'|variable=='Shortjaw Cisco'|
                            variable=='Pygmy Whitefish'|variable=='Round Whitefish'|variable=='Longnose Sucker')
ns.misc.spp.maxyr<-ns.misc.spp.maxyr[with(ns.misc.spp.maxyr, order(-value)),]
ns.misc.spp.1<-ns.misc.spp.maxyr[1,]
ns.misc.spp.2<-ns.misc.spp.maxyr[2,]
ns.misc.spp.3<-ns.misc.spp.maxyr[3,]

cisco.a1.maxyr<-subset(cisco.a1, YEAR==max(YEAR))
bloater.a1.maxyr<-subset(bloater.a1, YEAR==max(YEAR))
```


In `r max(all.data$YEAR)`, `r ns.topspp.maxyr$variable` had the highest nearshore average biomass. Trends in lakewide nearshore average biomass of individual prey fish species varied among species. Cisco biomass averaged `r ns.table.maxyr$Cisco` kg/ha in `r max(all.data$YEAR)`. This was generally **similar to** that observed during the prior ten-years and well **below** the period-of-record average of `r round(mean(ns.table$Cisco),1)` kg/ha (Table 2). **Trends in Bloater biomass were similar to that observed for Cisco**. Mean nearshore biomass for Bloater was `r ns.table.maxyr$Bloater` kg/ha in `r max(all.data$YEAR)`. This was **below** the long-term average of `r round(mean(ns.table$Bloater),1)` kg/ha (Table 2). Conversely, Lake Whitefish biomass in `r max(all.data$YEAR)` (`r ns.table.maxyr$Lake.Whitefish` kg/ha) was **similar to** the period-of-record average of `r round(mean(ns.table$Lake.Whitefish),1)` kg/ha. Likewise, average nearshore biomass of Rainbow Smelt biomass (`r ns.table.maxyr$Rainbow.Smelt` kg/ha) in `r max(all.data$YEAR)` was **equal to** the period-of-record average of `r round(mean(ns.table$Rainbow.Smelt),1)`. 


Nearshore Sculpin (Slimy, Spoonhead, and Deepwater) biomass was `r ns.table.maxyr$Sculpins` kg/ha in `r max(all.data$YEAR)`. This was **below** the period-of-record average of `r round(mean(ns.table$Sculpins),1)` kg/ha. **Other than the higher estimated densities in 2001 and 2010-11 (~0.05 kg/ha), nearshore sculpin densities have been between 0.01 and 0.03 kg/ha the past twenty years (Table 2). Proportionally, nearshore sculpin biomass has been distributed among sculpin species as ~50% slimy, ~20% Spoonhead, and ~30% Deepwater Sculpin. Over the period-of-record, Slimy Sculpin biomass has declined and Spoonhead and Deepwater Sculpin biomass have increased**.  

The combined mean nearshore biomass for all other forage fish species was `r ns.table.maxyr$Misc.Spp` kg/ha in `r max(all.data$YEAR)`. This was greater than the period-of-record mean of `r round(mean(ns.table$Misc.Spp),1)` kg/ha (Table 2). Miscellaneous species included Ninespine Stickleback, Trout-perch, Kiyi, Shortjaw Cisco, Pygmy Whitefish, Round Whitefish, and Longnose Sucker. Individual species biomass was highest for `r ns.misc.spp.1$variable` (`r round(ns.misc.spp.1$value,2)` kg/ha), `r ns.misc.spp.2$variable` (`r round(ns.misc.spp.2$value, 2)` kg/ha), and `r ns.misc.spp.3$variable` (`r round(ns.misc.spp.3$value,2)` kg/ha).

Two piscivorous fish vulnerable to our daytime nearshore bottom trawling are Burbot and juvenile Lake Trout. Burbot nearshore biomass averaged `r ns.table.maxyr$Burbot` kg/ha in `r max(all.data$YEAR)`, which was **equal to** the period-of-record mean of `r round(mean(ns.table$Burbot),2)` (Table 2). **However, Burbot biomass was roughly twice as high in most years prior to 1996 as compared to the past twenty years.** Hatchery Lake Trout biomass has been near zero since 2000, except for 2005, and the biomass in `r max(all.data$YEAR)` was `r ns.table.maxyr$hatchery.Lake.Trout` kg/ha (Table 2). Lean Lake Trout biomass was `r ns.table.maxyr$lean.Lake.Trout` kg/ha. This was similar to the long-term average of `r round(mean(ns.table$lean.Lake.Trout),2)` kg/ha (Table 2). Siscowet Lake Trout nearshore biomass was `r ns.table.maxyr$siscowet.Lake.Trout` kg/ha, which was **also equal to** the long-term average of `r round(mean(ns.table$siscowet.Lake.Trout),2)` (Table 2).
Densities of age-3 and younger lean and siscowet Lake Trout were `r age1.maxyr$lean.Lake.Trout` and `r age1.maxyr$siscowet.Lake.Trout` fish/ha in `r max(all.data$YEAR)`, respectively (Table 3), which was **less than** the period-of-record averages for both morphotypes (Table 3).

The density of age-1 prey fish was used as a measure of recruitment. Age-1 Cisco density was `r round(age1.maxyr$Cisco,1)` fish/ha in `r max(all.data$YEAR)`. Age-1 Cisco were collected at `r length(unique(cisco.a1.maxyr$LOCATION))` of the `r length(maxyr_nsstations$LOCATION)` nearshore stations sampled (Figure 5). **potential update on what age-1 density cutoff results in recruitment to the fishery if that work continues** Age-1 Bloater were collected at `r length(unique(bloater.a1.maxyr$LOCATION))` of the `r length(maxyr_nsstations$LOCATION)` nearshore stations and the average lakewide density was `r round(age1.maxyr$Bloater,1)` fish/ha in `r max(all.data$YEAR)` (Figure 5, Table 3). This was **below** the long-term average of `r round(mean(age1.table$Bloater),1)` fish/ha (Figure 6, Table 3). In contrast to other Coregonus species (Cisco, Bloater, and Kiyi), Lake Whitefish has exhibited more consistent recruitment and lower overall population biomass fluctuations over the period-of-record.  In `r max(all.data$YEAR)`, age-1 Lake Whitefish density was `r round(age1.maxyr$Lake.Whitefish,1)` fish/ha which was **similar to** the period-of-record average of `r round(mean(age1.table$Lake.Whitefish),1)` fish/ha (Table 3). Age-1 Rainbow Smelt density was `r round(age1.maxyr$Rainbow.Smelt,1)` fish/ha in `r max(all.data$YEAR)`, which was similar to the period-of-record average of `r round(mean(age1.table$Rainbow.Smelt),0)` fish/ha (Table 3).

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
a1.current<-rbind(age1.cast, kiyi.age1.cast)
a1.current<-a1.current%>%
  filter(SPECIES==202|SPECIES==204|SPECIES==206)%>%
  filter(YEAR==max(YEAR))
dates<-all.data%>%
  filter(YEAR==max(YEAR))
dates<-select(dates, c(2,8, 12, 13))
dates<-dates[!duplicated(dates$LOCATION),]
a1.current<-merge.data.frame(a1.current, dates, all=F)
a1.current<-merge.data.frame(a1.current, sci.names)
a1.current$station<-as.factor(a1.current$LOCATION)
a1.current$a1presence<-if_else(a1.current$value>0,'present','absent')

ls_poly <- readOGR(dsn = here('Data',"shapefiles/LakeSuperior"), layer = "lake_superior")
ls_poly <- spTransform(ls_poly, CRS("+proj=longlat"))
ls_poly.fort <- fortify(ls_poly)

##create map with stations color coded by biomass
a1map<-ggplot(a1.current, aes(BEG_LONGITUDE_DD, BEG_LATITUDE_DD)) +
  theme_bw() +
  scale_y_continuous()+
  scale_x_continuous(breaks=c(-93,-92,-91,-90,-89,-88,-87,-86,-85,-84), 
                     labels=c('-93','-92','-91','-90','-89','-88','-87','-86','-85','-84'))+
  geom_path(data = ls_poly.fort, aes(long, lat, group = group), size = 0.5)+
  geom_point(data=a1.current, mapping=aes(BEG_LONGITUDE_DD, BEG_LATITUDE_DD, color=a1presence), size=4, stroke=1.5)+
  scale_color_manual(values=c('gray85','red'), name='Age-1 occurrence')+
  map_theme+
  geom_text(aes(label=LOCATION))+
  labs( x='Longitude', y='Latitude')+
  theme(legend.position = c(0.2,0.8))

```

```{r, fig.width=12, fig.height=7, dpi=300, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(a1.current, aes(x=station, y=value, fill=COMMON_NAME))+
  geom_bar(position='stack', stat='identity')+
  aes(x=fct_reorder(station, OP_DATE))+
  annotation_custom(ggplotGrob(a1map), xmin=20, xmax=100, ymin=35, ymax=240)+
  plot_theme+
  theme(legend.position='bottom',
        axis.text.x=element_text(angle=90, hjust=1, vjust=0.5, size=12))+
  labs(x='Station, ordered by sampling date', y='Abundance (n per ha)', 
       title='Lake Superior Age-1 Ciscoe Abundance',
       subtitle=(paste('USGS bottom trawl assessment, ', a1.current$YEAR)),
       caption=ann_data_access)+
  scale_y_continuous(expand=c(0,0))+
  scale_fill_manual(values=c('darkorchid4','turquoise','darkorange1'), name=' ')

```
*Figure 5.* Estimated abundance (number/ha) of age-1 Bloater, Cisco, and Kiyi at individual nearshore and offshore sampling stations in `r max(all.data$YEAR)`. The inset map shows locations where age-1 Bloater, Cisco, and Kiyi were present or absent in `r max(all.data$YEAR)`.  

```{r, echo=FALSE, message=FALSE, warning=FALSE}
a1.ciscoes<-age1.ann.mean%>%
  filter(COMMON_NAME=='Bloater'|COMMON_NAME=='Cisco'|COMMON_NAME=='Kiyi')%>%
  filter(Year>1977)
```


```{r, fig.width=10, fig.height=6, dpi=300, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(a1.ciscoes, aes(x=(Year-1), y=Mean.NOHA))+
  geom_point(size=6)+
  geom_segment(aes(x=Year-1, xend=Year-1, y=0, yend=Mean.NOHA), size=1, color='black')+
  facet_grid(COMMON_NAME~., scales='free_y')+
  plot_theme+
  labs(x='Year Class', y='Mean abundance (n per ha)', caption=ann_data_access,
       title='Lake Superior Age-1 Ciscoe Abundance',
       subtitle='USGS bottom trawl assessment')+
  scale_x_continuous(expand=c(0,0), limits=c(1977,max(a1.ciscoes$Year)), breaks=seq(1977,max(a1.ciscoes$Year), by=5))+
  scale_y_continuous(expand=c(0,0),breaks = scales::pretty_breaks(5))+
  theme(panel.spacing=unit(2,'lines'))+
  coord_cartesian(clip='off')+
  geom_hline(yintercept=0, color='black', size=1)
```
*Figure 6.* Estimated annual average lakewide abundance (number/ha) of age-1 Bloater, Cisco, and Kiyi from 1978-`r max(all.data$YEAR)`. Bloater and Cisco estimates are from nearshore sites and Kiyi estimates are from offshore sampling sites for which sampling began in 2011. Y-axis scales differ among species. 

**Offshore survey**

Offshore water temperatures in July were **similar to** the past **eight**-year average (2011-`r max(all.data$YEAR)`, excluding 2012 when sampling was done in August rather than July, Figure 2). Offshore water temperatures in July `r max(all.data$YEAR)` averaged `r round(temp_july_surf$mean,1)` C (range = `r round(temp_july_surf$min,1)`-`r round(temp_july_surf$max,1)` C) at the surface and `r round(temp_july_100$mean,1)` C (range = `r round(temp_july_100$min,1)`-`r round(temp_july_100$max,1)` C) at 100 m (Figure 2). The previous **eight, will calculate 10yr avg once we have more years**-year average water temperatures for these same locations in July were `r round(temp_10yr_july_surf$mean,1)` C (range=`r round(temp_10yr_july_surf$min,1)`-`r round(temp_10yr_july_surf$max,1)` C) at the surface and `r round(temp_10yr_july_100$mean,1)` C (range = `r round(temp_10yr_july_100$min,1)`-`r round(temp_10yr_july_100$max,1)` C) at 100 m. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
os<-subset(all.data, TARGET==118|TARGET==117 & YEAR>2010)%>%
  filter(TR_DESIGN==25|TR_DESIGN==4)%>%
  filter(END_DEPTH>84)
##calculate mean biomass by year, start by getting total kgha for each station
os.ann.station.sum<-aggregate(os$KGHA, by=list(YEAR=os$YEAR, Station=os$LOCATION), FUN=sum)%>%
  renameCol('x','StationKGHA')

os.skewness<-os.ann.station.sum%>%
  group_by(YEAR)%>%
  do(describe(.$StationKGHA))

os.skewness.maxyr<-subset(os.skewness, YEAR==max(YEAR))

```


`r length(maxyr_osstations$LOCATION)` offshore sites were sampled in `r max(all.data$YEAR)` from which `r os.nfish$N_Fish` fish from `r length(os.spp.count$Offshore)` species or morphotypes were collected (Table 1). The average and median observed species richness across sites was `r round(os.effort.spp$mean,1)` and `r round(os.effort.spp$median, 1)` species, respectively, and ranged from `r os.effort.spp$min` to `r os.effort.spp$max` species. Individual offshore station biomass was non-normally distributed (Figure 7), but the variation in biomass estimates across offshore sites was less than that observed at nearshore locations (Figure 3). The skewness of the distribution of individual station biomass estimates in `r max(all.data$YEAR)` was `r round(os.skewness.maxyr$skew,1)` which was slightly **greater than** the period-of-record average skewness of `r round(mean(os.skewness$skew),1)`. 

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
os.ann.station.sum<-aggregate(os$KGHA, by=list(YEAR=os$YEAR, Station=os$LOCATION,
                                                     BEG_LONGITUDE_DD=os$BEG_LONGITUDE_DD,
                                                     BEG_LATITUDE_DD=os$BEG_LATITUDE_DD), FUN=sum)%>%
  renameCol('x','StationKGHA')
os.ann.station.sum2<-os.ann.station.sum%>%
  filter(YEAR==max(YEAR))
os.ann.station.sum2$Station<-as.factor(os.ann.station.sum2$Station)

ls_poly <- readOGR(dsn = here('Data',"shapefiles/LakeSuperior"), layer = "lake_superior")
ls_poly <- spTransform(ls_poly, CRS("+proj=longlat"))
ls_poly.fort <- fortify(ls_poly)

##map of offshore sites color ranked by biomass
osbiomap<-ggplot(os.ann.station.sum2, aes(BEG_LONGITUDE_DD, BEG_LATITUDE_DD)) +
  theme_bw()+
  scale_y_continuous(name='Latitude')+
  scale_x_continuous(name='Longitude', breaks=c(-93,-92,-91,-90,-89,-88,-87,-86,-85,-84), 
                     labels=c('-93','-92','-91','-90','-89','-88','-87','-86','-85','-84'))+
  geom_path(data = ls_poly.fort, aes(long, lat, group = group), size = 0.5)+
  geom_point(data=os.ann.station.sum2, mapping=aes(BEG_LONGITUDE_DD, BEG_LATITUDE_DD, color=StationKGHA), size=6, stroke=1.5)+
  scale_color_gradient(low='cadetblue2', high='red', name='Biomass\n(kg per ha)')+
  map_theme+
  geom_text(aes(label=Station))

```

```{r, fig.width=13, fig.height=7.5, dpi=300, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(os.ann.station.sum2, aes(x=Station, y=StationKGHA, fill=StationKGHA))+
  geom_bar(stat='identity')+
  scale_fill_gradient(low='cadetblue2', high='red', name='Fish biomass (kg per ha)', guide=F)+
  annotation_custom(ggplotGrob(osbiomap), ymin=7, ymax=26, xmax=23, xmin=1)+ #change these values if inset needs repositioning
  theme(axis.text.x=element_text(angle=90, hjust=1, vjust=0.5))+
  plot_theme+
  aes(x=fct_reorder(Station, StationKGHA))+
  labs(x='Offshore station identifier', y='Biomass (kg per ha)',
       caption=ann_data_access,
       title='Lake Superior Fish Biomass at Offshore Stations',
       subtitle=(paste('USGS bottom trawl assessment, ', os.ann.station.sum2$YEAR)))+
  scale_x_discrete(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0), breaks=c(0,5,10,15,20,25,30,35,40,45,50,55,60,65,70),
                     labels=c('0','5','10','15','20','25','30','35','40','45','50','55','60','65','70'))+
  geom_hline(yintercept = mean(os.ann.station.sum2$StationKGHA), size=1)
```
*Figure 7.*  Estimated biomass (kg/ha) at individual offshore stations in `r max(all.data$YEAR)`. The horizontal line is the `r max(all.data$YEAR)` lakewide offshore average biomass (`r round(os.effort.kgha$mean, 1)` kg/ha). The inset figure shows station locations and estimated biomass (kg/ha) in `r max(all.data$YEAR)`.

Deepwater Sculpin, Kiyi, and siscowet Lake Trout made up **99%** of the total number of individuals and biomass collected in offshore waters (Table 1, Figure 8). **Comment on the other species caught, if needed. Total fish biomass at offshore sites is normally distributed across the sampled depths (90-320 m) and peaks at about 180 m deep (Figure 8). Kiyi biomass was highest from about 140-200 m. Deepwater sculpin biomass was greatest and relatively similar at depths >150 m. Siscowet Lake Trout biomass peaked at about 170-220 m, but can be relatively high at all depths sampled by this survey (90-320 m, Figure 8).** 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
os<-subset(all.data, TARGET==118|TARGET==117 & YEAR>2010)%>%
  filter(TR_DESIGN==25|TR_DESIGN==4)%>%
  filter(END_DEPTH>84)

os.spp.compare<-subset(os, SPECIES==206|SPECIES==308|SPECIES==904)%>% 
  select(YEAR, LOCATION, SPECIES, KGHA)

##need to cast in sites where no fish of that species were caught
##to do this, need to figure out which sites were sampled each year
os.sites.byyear<-os%>%
  group_by(YEAR)%>%
  distinct(LOCATION)
os.sites.byyear$SITECHECK<-'SURVEYED'

os.spp.compare2<-merge.data.frame(os.spp.compare, os.sites.byyear, all=TRUE)
os.spp.compare2<-cast(os.spp.compare2, YEAR+LOCATION+SITECHECK~SPECIES, value='KGHA', fun.aggregate='mean')%>%
  select(c(1,2,4:6))
os.spp.compare2[is.na(os.spp.compare2)]<-0
os.spp.compare3<-melt.data.frame(os.spp.compare2, id.vars=c('YEAR','LOCATION'))%>%
  renameCol('value','KGHA')%>%
  renameCol('variable','SPECIES')

##means and st error calculations
os.spp.compare.mean<-os.spp.compare3%>%
  group_by(YEAR, SPECIES)%>%
  do(describe(.$KGHA))

##merge to get species names
os.spp.compare.mean<-merge.data.frame(os.spp.compare.mean, codes.to.names, all=F)

##spp means
os.means<-os.spp.compare.mean%>%
  group_by(COMMON_NAME)%>%
  dplyr::summarize(spp.mean=mean(mean))

os.means.kiyi<-subset(os.spp.compare.mean, SPECIES==206)
os.means.kiyi.maxyr<-subset(os.means.kiyi, YEAR==max(YEAR))

os.means.dws<-subset(os.spp.compare.mean, SPECIES==904)
os.means.dws.maxyr<-subset(os.means.dws, YEAR==max(YEAR))

os.means.sisc<-subset(os.spp.compare.mean, SPECIES==308)
os.means.sisc.maxyr<-subset(os.means.sisc, YEAR==max(YEAR))

os<-subset(all.data, TARGET==118|TARGET==117 & YEAR>2010)%>%
  filter(TR_DESIGN==25|TR_DESIGN==4)%>%
  filter(END_DEPTH>84)

os.ann.station.sum<-aggregate(os$KGHA, by=list(YEAR=os$YEAR, Station=os$LOCATION), FUN=sum)%>%
  renameCol('x','StationKGHA')

##calculate summary statistics
os.summary <- os.ann.station.sum%>% 
  group_by(YEAR) %>% 
  summarise_all(funs(mean,median,sd,std.error))%>%
  select(c(1,3,5,7,9))

##calculate mean biomass by year, start by getting total kgha for each station
os.ann.station.sum<-aggregate(os$KGHA, by=list(YEAR=os$YEAR, Station=os$LOCATION, Species=os$SPECIES, 
                                               EndDepth=os$END_DEPTH), FUN=sum)%>%
  renameCol('x','StationKGHA')
simplifyspp<-data.frame('Species'=c(109,127,130,204,206,211,308,317,902,903,904),
                        'Label'=c('Other', 'Other','Other','Other','Kiyi','Other','siscowet Lake Trout', 'Other','Other',
                                  'Other','Deepwater Sculpin'))
os.ann.station.sum<-merge.data.frame(os.ann.station.sum, simplifyspp)

os.current.yr<-os.ann.station.sum%>%
  filter(YEAR==max(YEAR))
os.current.yr$Station<-as.factor(os.current.yr$Station)

##plot biomass at each station for offshore cruise
os.current.yr$EndDepth<-round(os.current.yr$EndDepth,0)
os.current.yr$Station.Depth<-paste(os.current.yr$Station, os.current.yr$EndDepth, sep=', ')
```


Deepwater Sculpin offshore biomass averaged `r round(os.means.dws.maxyr$mean,1)` kg/ha in `r max(all.data$YEAR)`, which was **slightly less than** the period-of-record mean of `r round(mean(os.means.dws$mean),1)` kg/ha (Figure 9). Kiyi offshore biomass averaged `r round(os.means.kiyi.maxyr$mean,1)` kg/ha in `r max(all.data$YEAR)` which was **greater than** the period-of-record mean of `r round(mean(os.means.kiyi$mean),1)` kg/ha (Figure 9). Age-1 Kiyi density at offshore sites was `r round(age1.maxyr$Kiyi,1)` fish/ha in `r max(all.data$YEAR)` which was **less than** the 2011-`r max(all.data$YEAR)` average of `r round(mean(age1.table$Kiyi, na.rm=TRUE),1)` fish/ha (Table 3, Figure 6). Siscowet Lake Trout biomass averaged `r round(os.means.sisc.maxyr$mean,1)` kg/ha in `r max(all.data$YEAR)`, which was **greater than** the period-of-record mean of `r round(mean(os.means.sisc$mean),1)` kg/ha (Figure 9). 

```{r, fig.width=10, fig.height=6, dpi=300, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(os.current.yr, aes(x=Station.Depth, y=StationKGHA))+
  geom_bar(stat='identity', color='black', aes(fill=Label))+
  scale_fill_viridis(discrete=T, name='', breaks=c('Deepwater Sculpin','Kiyi','siscowet Lake Trout', 'Other'),
                     begin=1, end=0)+
  theme(legend.position=c(0.15,0.7),
        legend.direction = 'vertical',
        axis.text.x = element_text(angle=-90, vjust=0.5))+
  plot_theme+
  aes(x=fct_reorder(Station.Depth, EndDepth))+
  labs(x='Offshore station, ordered by depth (m)', y='Biomass (kg per ha)',
       caption=ann_data_access,
       title='Lake Superior Offshore Fish Biomass',
       subtitle=(paste('USGS bottom trawl assessment, ', os.current.yr$YEAR)))+
  scale_x_discrete(expand=c(0,0))+
  scale_y_continuous(expand=c(0,0), breaks=c(0,5,10,15,20,25,30,35,40,45,50,55,60,65,70),
                     labels=c('0','5','10','15','20','25','30','35','40','45','50','55','60','65','70'), limits=c(0,29))+
  geom_hline(yintercept=mean(os.summary$StationKGHA_mean), size=1)
```
*Figure 8.*  Estimated biomass (kg/ha) at individual offshore stations in `r max(all.data$YEAR)` for Deepwater Sculpin, Kiyi, siscowet Lake Trout, and other fish. The horizontal line is the average lakewide offshore total biomass in `r max(all.data$YEAR)` (`r round(os.effort.kgha$mean, 1)` kg/ha). Bars are ordered by depth from shallowest to deepest.


```{r, fig.width=10, fig.height=6, dpi=300, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(os.spp.compare.mean, aes(x=YEAR, y=mean))+
  geom_bar(stat='identity', fill='grey75', color='black')+
  geom_hline(data=os.means, aes(yintercept=spp.mean), size=1.5)+
  facet_grid(.~COMMON_NAME)+ ##in future years if this needs to be flipped so the facets are stacked vertically: (COMMON_NAME~.)
  plot_theme+
  labs(x='Year', y='Mean biomass (kg per ha)', caption=ann_data_access,
       title='Lake Superior Offshore Fish Biomass',
       subtitle='USGS bottom trawl assessment')+
  scale_x_continuous(expand=c(0,0), breaks=pretty(os.spp.compare.mean$YEAR))+
  scale_y_continuous(expand=c(0,0), breaks=c(0,1,2,3,4,5),
                     labels=c('0', '1', '2','3','4','5'), limits=c(0,5))+
  geom_errorbar(data=os.spp.compare.mean, aes(x=YEAR, ymin=mean-se, ymax=mean+se), width=0.4)
```
Figure 9.  Annual offshore biomass estimates (mean lakewide kg/ha +/- standard error) for Deepwater Sculpin, Kiyi, and siscowet Lake Trout. The horizontal lines are period-of-record (2011-`r max(all.data$YEAR)`) means for each species.

**Summary**

WRITE SOME NEW STUFF EACH YEAR. Biomass trends in other nearshore demersal species have been generally steady over the past five years with some species, such as Lake Whitefish, Ninespine Stickleback, and Longnose Sucker exhibiting increases in biomass over the past 10 -20 years (Figure 10).

The combination of our near- and offshore bottom trawl surveys provide a lakewide picture of the status and trends of the Lake Superior fish community susceptible to bottom trawls, particularly with respect to describing survival of Coregonus species to age-1 and offshore Deepwater Sculpin, Kiyi, and siscowet Lak Trout populations. Our plan is to continue these surveys into the future and adapt them as needed to address emerging issues. 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ns<-all.data%>%
  filter(TARGET==2)%>%
  filter(YEAR>1977)

ns.spp.compare<-subset(ns, SPECIES==202|SPECIES==204|SPECIES==211|SPECIES==130|
                         SPECIES==131|SPECIES==902|SPECIES==903|SPECIES==904|SPECIES==109|
                         SPECIES==404|SPECIES==127|SPECIES==203)%>% ##input the species codes you want
  select(YEAR, LOCATION, SPECIES, KGHA)

##need to cast in sites where no fish of that species were caught
##to do this, need to figure out which sites were sampled each year
ns.sites.byyear<-ns%>%
  group_by(YEAR)%>%
  distinct(LOCATION)
ns.sites.byyear$SITECHECK<-'SURVEYED'

ns.spp.compare2<-merge.data.frame(ns.spp.compare, ns.sites.byyear, all=TRUE)
ns.spp.compare2<-cast(ns.spp.compare2, YEAR+LOCATION+SITECHECK~SPECIES, value='KGHA', fun.aggregate='mean')%>%
  select(c(1,2,4:15))
ns.spp.compare2[is.na(ns.spp.compare2)]<-0
ns.spp.compare<-melt.data.frame(ns.spp.compare2, id.vars=c('YEAR','LOCATION'))%>%
  renameCol('value','KGHA')%>%
  renameCol('variable','SPECIES')

##now find the mean of each species for each year
ns.spp.compare.mean<-aggregate(ns.spp.compare$KGHA, by=list(Year=ns.spp.compare$YEAR, SPECIES=ns.spp.compare$SPECIES), FUN=mean)%>%
  renameCol('x', 'meanKGHA')

##merge to get species names
ns.spp.compare.mean<-merge.data.frame(ns.spp.compare.mean, sci.names, all=F)

##calculate 5, 10, and 20 year means for each species
ns.spp5mean<-ns.spp.compare.mean%>%
  filter(Year>=max(Year)-4)
ns.spp5mean<-aggregate(ns.spp5mean$meanKGHA, by=list(Spp=ns.spp5mean$COMMON_NAME), FUN=mean)%>%
  renameCol('x','meanKGHA')
ns.spp5mean$period<-'5 year mean'
ns.spp10mean<-ns.spp.compare.mean%>%
  filter(Year>=max(Year)-9)
ns.spp10mean<-aggregate(ns.spp10mean$meanKGHA, by=list(Spp=ns.spp10mean$COMMON_NAME), FUN=mean)%>%
  renameCol('x','meanKGHA')
ns.spp10mean$period<-'10 year mean'
ns.spp20mean<-ns.spp.compare.mean%>%
  filter(Year>=max(Year)-19)
ns.spp20mean<-aggregate(ns.spp20mean$meanKGHA, by=list(Spp=ns.spp20mean$COMMON_NAME), FUN=mean)%>%
  renameCol('x','meanKGHA')
ns.spp20mean$period<-'20 year mean'

ns.periodmeans<-rbind(ns.spp5mean, ns.spp10mean, ns.spp20mean)

##calculate the mean for the last two years of sampling that will be used to compare to the 5, 10, and 20 year means
ns.spp2mean<-ns.spp.compare.mean%>%
  filter(Year>=max(Year)-1)
ns.spp2mean<-aggregate(ns.spp2mean$meanKGHA, by=list(Spp=ns.spp2mean$COMMON_NAME), FUN=mean)%>%
  renameCol('x','present2KGHA')

##percent change calculations
ns.periodmeans<-merge.data.frame(ns.periodmeans, ns.spp2mean, all=T)
ns.periodmeans$percentchange<-((ns.periodmeans$present2KGHA/ns.periodmeans$meanKGHA)*100)-100
ns.periodmeans$posneg<-if_else(ns.periodmeans$percentchange>0,'positive','negative')
ns.periodmeans$period_f<-factor(ns.periodmeans$period, levels=c('20 year mean','10 year mean','5 year mean'))

```

```{r, fig.width=12, fig.height=7, dpi=300, echo=FALSE, message=FALSE, warning=FALSE}
ggplot(ns.periodmeans, aes(x=percentchange, y=Spp, fill=posneg))+
  geom_segment(aes(x=0, xend=percentchange, y=Spp, yend=Spp))+
  geom_point(size=6, shape=21)+
  scale_fill_manual(values=c('red', 'cadetblue2'), guide=F)+
  scale_y_discrete(limits=c('Longnose Sucker','Rainbow Smelt','Ninespine Stickleback','Lake Whitefish','Burbot','Trout-perch', 
                            'Spoonhead Sculpin','Pygmy Whitefish','Slimy Sculpin','Deepwater Sculpin', 'Bloater','Cisco'))+
  plot_theme+
  facet_grid(.~period_f)+
  geom_vline(xintercept=0, size=2, color='black')+
  labs(x='Percent change in two-year mean biomass (kg per ha) as compared to time period', y='', 
       title='Lake Superior Nearshore Fish Biomass Trends',
       subtitle='USGS bottom trawl assessment',
       caption=ann_data_access)
```
*Figure 10.* Comparison of the average biomass of common nearshore species in `r (max(all.data$YEAR)-1)`-`r max(all.data$YEAR)` to average biomass estimates for the previous five, ten, and 20-year time periods.   

Note: All GLSC sampling and handling of fish during research are carried out in accordance with guidelines for the care and use of fishes by the American Fisheries Society (http://fisheries.org/docs/wp/Guidelines-for-Use-of-Fishes.pdf).

```{r, echo=FALSE, message=FALSE, warning=FALSE}
ns.table.names<-data.frame(oldnames=c('Year', 'Sites', 'No.fish.sites','Total.species.collected', 'Total.biomass', 'Median.biomass', 'Rainbow.Smelt',  'Cisco', 'Lake.Whitefish', 'Bloater', 'hatchery.Lake.Trout', 'lean.Lake.Trout', 'siscowet.Lake.Trout', 'Burbot', 'Sculpins', 'Misc.Spp'), newnames=c('Year', 'Sites', 'No fish sites','Total species collected', 'Total biomass', 'Median biomass', 'Rainbow Smelt', 'Cisco', 'Lake Whitefish', 'Bloater', 'hatchery Lake Trout', 'lean Lake Trout', 'siscowet Lake Trout', 'Burbot', 'Sculpins', 'Misc Spp'))

names(ns.table)<-ns.table.names$newnames[match(names(ns.table), ns.table.names$oldnames)]

a1.table.names<-data.frame(oldnames=c('Year','Year.Class', 'Rainbow.Smelt', 'Cisco', 'Bloater', 'Lake.Whitefish', 'Kiyi', 'lean.Lake.Trout', 'siscowet.Lake.Trout'), newnames=c('Year','Year Class', 'Rainbow Smelt', 'Cisco', 'Bloater', 'Lake Whitefish', 'Kiyi', 'lean Lake Trout', 'siscowet Lake Trout'))

names(age1.table)<-a1.table.names$newnames[match(names(age1.table), a1.table.names$oldnames)]
```


*Table 1.* Fish species and the number of individuals collected in nearshore and offshore bottom trawl surveys in Lake Superior in `r max(all.data$YEAR)`. Sampling locations shown in Figure 1. 
```{r, echo=FALSE, message=FALSE, warning=FALSE}
knitr::kable(all.spp.counts2, row.names = FALSE, align='r', format='markdown')

```

*Table 2.* Mean annual Lake Superior nearshore bottom trawl biomass (kg/ha) estimates for common fishes. Sculpin includes Slimy, Spoonhead, and Deepwater sculpin. Mean and median total biomass includes all species. Miscellaneous species includes Ninespine Stickleback, Trout-Perch, Kiyi, Shortjaw Cisco, Pygmy Whitefish, Round Whitefish, and Longnose Sucker. No fish sites are the number of locations where no fish were collected.
```{r, echo=FALSE, message=FALSE, warning=FALSE}
kable(ns.table, digits=1, align='r', row.names=FALSE, format='markdown')
```

*Table 3.* Mean annual Lake Superior bottom trawl age-1 density (number/ha) estimates for nearshore collected Cisco, Bloater, Lake Whitefish, and Rainbow Smelt, nearshore small lean and siscowet Lake Trout (<age-3), and offshore collected age-1 Kiyi. Age-1 fish were defined by species-specific lengths: Cisco <140 mm, Bloater <130 mm, Lake Whitefish <160 mm, Rainbow Smelt <100 mm, and Kiyi <130 mm. Lean and siscowet Lake Trout data are for fish <226 mm (~< age 3).  
```{r, echo=FALSE, message=FALSE, warning=FALSE}
kable(age1.table, digits=1, align='r', row.names=FALSE, format='markdown')
```

```{r, echo=FALSE, message=FALSE, warning=FALSE}
timestamp()
```

